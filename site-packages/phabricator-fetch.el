;;; phabricator-fetch.el --- -*- lexical-binding: t; -*-
;;
;; Filename: phabricator-fetch.el
;; Description:
;; Author: Renat Galimov
;; Maintainer:
;; Created: Tue Nov 17 11:08:45 2020 (+0300)
;; Version:
;; Package-Requires: ()
;; Last-Updated: 1
;;           By: 1
;;     Update #: 6
;; URL:
;; Doc URL:
;; Keywords:
;; Compatibility:
;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;;; Commentary:
;;
;;
;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;;; Change Log:
;;
;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;; This program is free software: you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation, either version 3 of the License, or (at
;; your option) any later version.
;;
;; This program is distributed in the hope that it will be useful, but
;; WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
;; General Public License for more details.
;;
;; You should have received a copy of the GNU General Public License
;; along with GNU Emacs.  If not, see <https://www.gnu.org/licenses/>.
;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;
;;; Code:

(require 'url)
(require 'request)
(require 'generator)
(require 'org)

(defvar phabricator-fetch-api-url "https://secure.phabricator.com/api")
(defvar phabricator-fetch-api-token "")
(defvar phabricator-fetch-user-phid "")
(defvar phabricator-fetch-see-tasks-buffer "*Phabricator*")

(defun phabricator-fetch-endpoint-url (endpoint)
  "Make phabricator URL for the `ENDPOINT`."
  (let* ((url (url-generic-parse-url phabricator-fetch-api-url))
         (filename (expand-file-name  endpoint (url-filename url))))
    (setf (url-filename url) filename)
    (url-recreate-url url)))


(defun phabricator-fetch--tasks-constraints (&rest args)
  "Create constratints argument for a query function.

ARGS -
    :ids      - an integer list of task ids
    :statuses - a string list of possible statuses
    :assigned - a string list of assignee PHIDs"
  (let ((i 0)
        (constraints '())
        (ids (or (plist-get args :ids) '()))
        (statuses (or (plist-get args :statuses) '()))
        (assigned (or (plist-get args :assigned) '())))
    (if (not (sequencep ids))
        (error ":statuses should be of a sequence type"))
    (if (not (sequencep statuses))
        (error ":statuses should be of a sequence type"))
    (if (not (sequencep assigned))
        (error ":assigned should be of a sequence type"))

    (dolist (id ids)
      (let ((query-arg (format "constraints[ids][%d]" i)))
        (push `(,query-arg . ,id) constraints))
      (setq i (1+ i)))

    (setq i 0)
    (dolist (user-phid assigned)
      (let ((query-arg (format "constraints[assigned][%d]" i)))
        (push `(,query-arg . ,user-phid) constraints))
      (setq i (1+ i)))

    (setq i 0)
    (dolist (status statuses)
      (let ((query-arg (format "constraints[statuses][%d]" i)))
        (push `(,query-arg . ,status) constraints))
        (setq i (1+ i)))
    constraints
    ))

(iter-defun phabricator-fetch-iter-tasks (&rest args)
  "Fetch all tasks in open state that are assigned to me"

  (let* ((tasks [])
         (i 0)
         (error-info nil)
         (after (plist-get args :after))
         (constraints (apply 'phabricator-fetch--tasks-constraints args))
         (data `(("api.token" . ,phabricator-fetch-api-token)
                 ("limit" . "100"))))
    (if after
        (push `(after . ,after) data)
      )

    (dolist (constraint constraints)
      (push constraint data)
      )

    (request (phabricator-fetch-endpoint-url "maniphest.search")
      :parser 'json-read
      :type "POST"
      :data data
      :sync t
      :success (cl-function
                (lambda (&key data &allow-other-keys)
                  (when data
                    (setq error-info (alist-get 'error_info data))
                    (when (not error-info)
                      (setq after (alist-get 'after (alist-get 'cursor (alist-get 'result data))))
                      (setq tasks (alist-get 'data (alist-get 'result data)))))))
      :error (cl-function
              (lambda (&key error-thrown &allow-other-keys)
                (error "Can't fetch tasks: %S" (alist-get 'result error-thrown)))))

    (when error-info (error "Can't fetch tasks: %s" error-info))

    (while (< i (length tasks))
      (iter-yield (elt tasks i))
      (setq i (1+ i))
      )
    (when after
      (iter-yield-from (apply 'phabricator-fetch-iter-tasks (plist-put args :after after))))))


(defun phabricator-fetch--indent (input size)
  "Indent `INPUT` with `SIZE` spaces."
  (if (not (integerp size))
      (error "Size should be an integer.  Got: %s" (type-of size))
    )

  (if (not (stringp input))
      (error "Input should be a string.  Got: %s" (type-of input))
    )
  (mapconcat (lambda (line) (concat (make-string size ? ) line)) (split-string input "\n") "\n"))


(defun phabricator-fetch-format-task (task)
  "Formats the `TASK` into `org-mode` entry."
  (let* ((fields (alist-get 'fields task))
         (description (alist-get 'raw (alist-get 'description fields)))
         (task-id (alist-get 'id task))
         (name (alist-get 'name fields)))
    (mapconcat
     'identity
     `(,(concat "* TODO " name)
       "  :PROPERTIES:"
       ,(concat "  :PHABRICATOR_ID: T" (number-to-string task-id))
       "  :END:"
       "  :PHABRICATOR_DESCRIPTION:"
       ,(phabricator-fetch--indent description 2)
       "  :END:")
     "\n")))

(defun phabricator-fetch-see-tasks (&rest args)
  "Fetched phabricator tasks into `org-mode` formatted buffer.
Fetches all tasks assigned to `phabricator-fetch-user-phid`
into `phabricator-fetch-see-tasks-buffer`.
Notice that the function cleans the buffer before updating it.

Supported ARGS:

`exclude`: exclude given tasks from the output."
  (interactive)
  (let (
        (exclude (or (plist-get args :exclude) '()))
        (tasks (apply 'phabricator-fetch-iter-tasks args))
        )
    (with-current-buffer (get-buffer-create "*Phabricator*")
      (erase-buffer)
      (iter-do (task tasks)
        (let ((task-id (format "T%s" (alist-get 'id task))))
          (when (not (member task-id exclude))
              (insert (format "%s\n" (phabricator-fetch-format-task task))))))
      (org-mode)
      (pop-to-buffer (current-buffer)))))

;; (phabricator-fetch-see-tasks
;;  :statuses '(open)
;;  :assigned `(,phabricator-fetch-user-phid)
;;  :exclude (phabricator-fetch--get-existing-task-ids)
;;  )

;; (phabricator-fetch-see-tasks
;;  :ids (phabricator-fetch--id-to-int (phabricator-fetch--get-existing-task-ids))
;;  :statuses '(resolved wontfix spite)
;;  )

(defun phabricator-fetch-get-closed-task-ids ()
  "Get id's of tasks defined in `org-agenda-buffers` and having closed status."
  (let* ((all-task-ids (phabricator-fetch--id-to-int (phabricator-fetch--get-existing-task-ids)))
        (tasks (phabricator-fetch-iter-tasks :ids all-task-ids :statuses '(resolved wontfix spite)))
        (result '()))
    (iter-do (task tasks)
      (push (alist-get 'id task) result))
    result))

(defun phabricator-fetch-update-task-statuses ()
  "Update status of closed tasks to DONE."
  (interactive)
  (let ((total-updated 0)
        (done-task-ids (phabricator-fetch-get-closed-task-ids)))
    (org-map-entries
     (lambda ()
       (let* ((current-task-id (assoc-default "PHABRICATOR_ID" (org-entry-properties)))
              (current-task-int-id (string-to-number (substring current-task-id 1 nil))))
         (when (member current-task-int-id done-task-ids)
           (org-todo "DONE")
           (setq total-updated (1+ total-updated)))))
     "+TODO=\"TODO\"&-PHABRICATOR_ID=\"\""
     'agenda)
    (message "Total updated: %s" total-updated)))

(defun phabricator-fetch--id-to-int (ids)
  "Convert IDS from user-friendly string to integer."
  (mapcar
   (lambda (id)
     (string-to-number (substring id 1 nil)))
   ids))

(defun phabricator-fetch--get-existing-task-ids ()
  "Return a list of phabricator tasks."
  (org-map-entries
   (lambda () (assoc-default "PHABRICATOR_ID" (org-entry-properties)))
   "-PHABRICATOR_ID=\"\""
   'agenda))


(provide 'phabricator-fetch)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;; phabricator-fetch.el ends here
